// --- åƒ…ä¿®æ”¹é€™éƒ¨åˆ†é‚è¼¯ï¼Œå…¶é¤˜çµæ§‹å®Œå…¨ä¸å‹• ---

async function fetchLoop() {
    // 1. åŸæœ‰çš„ LASS æ¸¬ç«™æ•¸æ“šæŠ“å– (A, B, C)
    for(let k in config) {
        if(k === 'P') continue; // è·³é Pï¼Œå› ç‚º P è¦æŠ“ GAS çš„æ•¸æ“š
        try {
            const r = await fetch(`https://pm25.lass-net.org/data/last.php?device_id=${config[k].id}`);
            const j = await r.json();
            cache[k] = j.feeds[0][Object.keys(j.feeds[0])[0]];
        } catch(e){ console.log(k + " LASS fetch error"); }
    }

    // 2. é‡å°æ¤ç‰©å€ (P) æŠ“å–ä½ çš„ Google Sheets æ•¸æ“š
    try {
        const gasUrl = "https://script.google.com/macros/s/AKfycbzAaqP79kMX9Uq_QtIqnwMx8tp2v62k6H5lDOCtCZV2W73NwfWN9kFdMz0Myalx2vxRFw/exec"; // ğŸ‘ˆ è«‹å¡«å…¥ä½ çš„ GAS éƒ¨ç½²ç¶²å€
        const rP = await fetch(gasUrl);
        const jP = await rP.json();
        if(jP && jP.length > 0) {
            cache['P'] = jP[0]; // å„²å­˜ä¾†è‡ª Sheet çš„æœ€æ–°ä¸€ç­†è³‡æ–™
        }
    } catch(e){ console.log("Plant GAS fetch error"); }

    updateMap();
    if(currentKey !== 'HOME') updateDashboard();
    document.getElementById('status-text').innerText = "æ•¸æ“šåŒæ­¥æˆåŠŸ";
}

function updateDashboard() {
    const d = cache[currentKey]; if(!d) return;
    
    if(currentKey === 'P') {
        // ğŸƒ æ¤ç‰©å€å°ˆç”¨ï¼šç²¾ç¢ºå››æ ¼é…ç½® (å°æ‡‰ä½  Sheet Script çš„æ¬„ä½åç¨±)
        document.getElementById('l1').innerText = "ç’°å¢ƒæº«åº¦";
        document.getElementById('v1').innerHTML = `${parseFloat(d["æº«åº¦"]).toFixed(1)} <span class="val-unit">Â°C</span>`;
        
        document.getElementById('l2').innerText = "ç’°å¢ƒæ¿•åº¦";
        document.getElementById('v2').innerHTML = `${Math.round(d["æ¿•åº¦"])} <span class="val-unit">%</span>`;
        
        document.getElementById('l3').innerText = "åœŸå£¤æ¿•åº¦";
        document.getElementById('v3').innerHTML = `${Math.round(d["åœŸå£¤æ¿•åº¦"])} <span class="val-unit">%</span>`;
        
        document.getElementById('l4').innerText = "äºŒæ°§åŒ–ç¢³ (CO2)";
        document.getElementById('v4').innerHTML = `${Math.round(d["CO2"])} <span class="val-unit">ppm</span>`;
    } else {
        // ğŸ« ä¸€èˆ¬æ¸¬ç«™ (ç¶­æŒåŸæ¨£)
        document.getElementById('l1').innerText = "å³æ™‚æº«åº¦";
        document.getElementById('v1').innerHTML = `${d.s_t0.toFixed(1)} <span class="val-unit">Â°C</span>`;
        document.getElementById('l2').innerText = "ç›¸å°æ¿•åº¦";
        document.getElementById('v2').innerHTML = `${Math.round(d.s_h0)} <span class="val-unit">%</span>`;
        document.getElementById('l3').innerText = "ç´°æ‡¸æµ®å¾®ç²’ (PM2.5)";
        document.getElementById('v3').innerHTML = `${Math.round(d.s_d0)} <span class="val-unit">Î¼g/mÂ³</span>`;
        document.getElementById('l4').innerText = "äºŒæ°§åŒ–ç¢³ (CO2)";
        document.getElementById('v4').innerHTML = `${Math.round(d.s_g8)} <span class="val-unit">ppm</span>`;
    }
}
