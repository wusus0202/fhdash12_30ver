<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>FH EnivroDashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        /* 完全保留你原本的所有 CSS 排版 */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f2f2f2; }
        .header { height: 70px; background: #d9cecd; color: #333; display: flex; align-items: center; padding: 0 24px; font-size: 18px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .mqtt-notification { position: absolute; top: 10px; right: 24px; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 500; min-width: 120px; text-align: center; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; z-index: 100; }
        .mqtt-notification.show { opacity: 1; transform: translateY(0); }
        .mqtt-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .mqtt-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .app-container { display: flex; flex-direction: column; height: 92vh; }
        .app { display: flex; flex: 1; }
        .sidebar { width: 260px; background: #4a4545; color: #fff; padding: 20px; display: flex; flex-direction: column; }
        .menu { display: flex; flex-direction: column; gap: 10px; }
        .menu div { padding: 12px 16px; border-radius: 8px; border: 1px solid #777; font-size: 14px; cursor: pointer; background: #4a4545; color: #fff; }
        .dropdown-container { position: relative; margin-bottom: 10px; }
        .dropdown-btn { padding: 12px 16px; border-radius: 8px; border: 1px solid #777; font-size: 14px; cursor: pointer; background: #fff !important; color: #333 !important; width: 100%; text-align: left; }
        .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; background: #4a4545; border: 1px solid #777; border-radius: 8px; list-style: none; padding: 0; margin: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .dropdown-list li { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #5a5555; color: #fff; }
        .dropdown-list.hidden { display: none; }
        .clock { margin-top: auto; height: 160px; border-radius: 16px; background: #5b5555; padding: 20px; display: flex; gap: 16px; color: #fff; align-items: center; }
        #clock-svg { width: 72px; height: 72px; }
        .clock-digital { flex: 1.3; display: flex; flex-direction: column; justify-content: center; gap: 4px; }
        .main { flex: 1; padding: 24px; display: flex; flex-direction: column; gap: 24px; }
        .pm25-box { background: #e8e8e8; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; padding: 40px; }
        .pm25-value { font-size: 64px; font-weight: 500; }
        #plant-layout { display: none; }
        #plant-layout.active { display: flex; flex-direction: column; gap: 24px; }
        .plant-row { display: flex; gap: 24px; margin-top: 20px; }
        .plant-card { flex: 1; background: #e8e8e8; border-radius: 24px; padding: 20px; text-align: center; color: #888; }
        .plant-card .val { font-size: 28px; font-weight: bold; color: #555; }
    </style>
</head>
<body>
    <header class="header">
        芳和實驗中學環境現況
        <div id="mqtt-status" class="mqtt-notification"></div>
    </header>

    <div class="app-container">
        <div class="app">
            <aside class="sidebar">
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="source-selector">小芳堂 ▼</button>
                    <ul class="dropdown-list hidden" id="source-list">
                        <li data-source="A">小芳堂</li>
                        <li data-source="E">植物觀測</li>
                    </ul>
                </div>
                <div class="menu">
                    <div>PM2.5</div><div>溫度</div><div>日照</div><div>風速</div><div>濕度</div><div>碳排放</div><div>有機物</div><div>用電量</div>
                </div>
                <div class="clock">
                    <svg id="clock-svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#fff" stroke-width="4"/>
                        <rect id="hour-hand" x="48" y="25" width="4" height="25" rx="2" fill="#ddd" transform-origin="50 50"/>
                        <rect id="minute-hand" x="48.5" y="18" width="3" height="32" rx="1.5" fill="#fff" transform-origin="50 50"/>
                        <rect id="second-hand" x="49" y="16" width="2" height="34" rx="1" fill="#ff4444" transform-origin="50 50"/>
                    </svg>
                    <div class="clock-digital">
                        <div id="date-display" style="font-size:12px;"></div>
                        <div id="time-display" style="font-size:16px; font-weight:bold;"></div>
                    </div>
                </div>
            </aside>

            <main class="main" id="standard-layout">
                <div class="pm25-box">
                    <div style="font-size:20px;">PM2.5</div>
                    <div class="pm25-value" id="pm25-val">-- μg/m³</div>
                </div>
            </main>

            <main class="main" id="plant-layout">
                <div class="pm25-box">
                    <div style="font-size:20px;">植物監測 PM2.5</div>
                    <div class="pm25-value" id="plant-pm25">-- μg/m³</div>
                </div>
                <div class="plant-row">
                    <div class="plant-card"><div>濕度</div><div class="val" id="plant-hum">-- %</div></div>
                    <div class="plant-card"><div>溫度</div><div class="val" id="plant-temp">-- °C</div></div>
                    <div class="plant-card"><div>土壤濕度</div><div class="val" id="plant-soil">--</div></div>
                    <div class="plant-card"><div>CO2</div><div class="val" id="plant-co2">--</div></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // 使用你 image_b3ae28.png 截圖中的最新連線資料
        const CONFIG = {
            host: "e469614474c34ae1a868aba7623b7552.s1.eu.hivemq.cloud",
            port: 8884, // WebSocket SSL Port
            user: "wusus",
            pass: "Webberwusus0202",
            path: "/mqtt"
        };

        let client = null;
        let currentSource = 'A';

        // 下拉選單邏輯
        const btn = document.getElementById('source-selector');
        const list = document.getElementById('source-list');
        btn.onclick = () => list.classList.toggle('hidden');

        document.querySelectorAll('#source-list li').forEach(li => {
            li.onclick = () => {
                currentSource = li.dataset.source;
                btn.textContent = li.textContent + " ▼";
                list.classList.add('hidden');
                
                if(currentSource === 'E') {
                    document.getElementById('standard-layout').style.display = 'none';
                    document.getElementById('plant-layout').classList.add('active');
                    connectMQTT(); // 觸發連線
                } else {
                    if(client) client.disconnect();
                    document.getElementById('plant-layout').classList.remove('active');
                    document.getElementById('standard-layout').style.display = 'flex';
                    fetchLASS();
                }
            };
        });

        // 核心連線函數：加入 Paho 是否定義的檢查
        function connectMQTT() {
            if (typeof Paho === "undefined") {
                console.warn("MQTT Library 載入中...");
                setTimeout(connectMQTT, 500); // 0.5秒後重試
                return;
            }

            const cid = "fh_web_" + Math.random().toString(16).substr(2, 8);
            client = new Paho.MQTT.Client(CONFIG.host, CONFIG.port, CONFIG.path, cid);

            client.onMessageArrived = (m) => {
                const t = m.destinationName, v = m.payloadString;
                if(t.includes("pm25")) document.getElementById('plant-pm25').textContent = v + " μg/m³";
                if(t.includes("humidity")) document.getElementById('plant-hum').textContent = v + " %";
                if(t.includes("temp")) document.getElementById('plant-temp').textContent = v + " °C";
                if(t.includes("soil")) document.getElementById('plant-soil').textContent = v;
                if(t.includes("co2")) document.getElementById('plant-co2').textContent = v;
            };

            client.connect({
                useSSL: true,
                userName: CONFIG.user,
                password: CONFIG.pass,
                onSuccess: () => {
                    const status = document.getElementById('mqtt-status');
                    status.textContent = "MQTT 已連線";
                    status.className = "mqtt-notification mqtt-success show";
                    client.subscribe("plant/#");
                    setTimeout(() => status.classList.remove('show'), 3000);
                },
                onFailure: (e) => {
                    const status = document.getElementById('mqtt-status');
                    status.textContent = "連線失敗";
                    status.className = "mqtt-notification mqtt-error show";
                }
            });
        }

        async function fetchLASS() {
            try {
                const r = await fetch('https://pm25.lass-net.org/data/last.php?device_id=B827EBC2994D');
                const d = await r.json();
                document.getElementById('pm25-val').textContent = (d.s_d0 || '--') + " μg/m³";
            } catch(e) {}
        }

        function updateClock() {
            const n = new Date();
            const h = n.getHours(), m = n.getMinutes(), s = n.getSeconds();
            document.getElementById('hour-hand').setAttribute('transform', `rotate(${(h%12)*30 + m*0.5} 50 50)`);
            document.getElementById('minute-hand').setAttribute('transform', `rotate(${m*6} 50 50)`);
            document.getElementById('second-hand').setAttribute('transform', `rotate(${s*6} 50 50)`);
            document.getElementById('date-display').textContent = n.toLocaleDateString();
            document.getElementById('time-display').textContent = n.toLocaleTimeString('zh-TW', {hour12:false});
        }

        setInterval(updateClock, 1000);
        updateClock();
        fetchLASS();
    </script>
</body>
</html>
