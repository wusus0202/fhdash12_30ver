<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>èŠ³å’Œå¯¦é©—ä¸­å­¸ç’°å¢ƒç›£æ¸¬ç³»çµ±</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://unpkg.com/paho-mqtt@1.0.1/paho-mqtt.min.js"></script>
    <script type="importmap">
    {
      "imports": {
        "@google/genai": "https://esm.sh/@google/genai"
      }
    }
    </script>

    <style>
        /* ä¿ç•™ä½ åŸæœ¬æ‰€æœ‰çš„ CSS æ¨£å¼ */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f2f2f2; }
        .header { height: 70px; background: #d9cecd; color: #333; display: flex; align-items: center; padding: 0 24px; font-size: 18px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        
        /* æ–°å¢ï¼šAI å»ºè­°å€å¡Šæ¨£å¼ */
        .ai-insight-box {
            grid-column: 1 / span 3;
            background: #fff;
            border-left: 6px solid #4a4545;
            padding: 20px;
            border-radius: 16px;
            margin-top: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        
        /* ä½ åŸæœ¬çš„å…¶é¤˜ CSS... (ç‚ºäº†ç°¡æ½”ï¼Œé€™è£¡çœç•¥ï¼Œè«‹ä¿ç•™ä½ åŸæœ¬ä»£ç¢¼ä¸­çš„ style å…§å®¹) */
        .app-container { display: flex; flex-direction: column; height: 92vh; }
        .app { display: flex; flex: 1; }
        .sidebar { width: 260px; background: #4a4545; color: #fff; padding: 20px; display: flex; flex-direction: column; }
        .menu { display: flex; flex-direction: column; gap: 10px; }
        .menu div { padding: 12px 16px; border-radius: 8px; border: 1px solid #777; font-size: 14px; cursor: pointer; transition: background 0.2s; background: #4a4545; color: #fff; }
        .dropdown-btn { padding: 12px 16px; border-radius: 8px; border: 1px solid #777; font-size: 14px; cursor: pointer; background: #fff !important; color: #333 !important; width: 100%; text-align: left; }
        .clock { margin-top: auto; height: 160px; border-radius: 16px; background: #5b5555; padding: 20px; display: flex; gap: 16px; color: #fff; align-items: center; }
        .main { flex: 1; padding: 24px; display: flex; flex-direction: column; gap: 24px; height: 100%; }
        .columns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; height: 100%; }
        .pm25 { grid-column: 1 / span 2; background: #e8e8e8; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; padding: 16px; }
        .pm25-value { font-size: 48px; font-weight: 500; }
        .plant-top-pm25 { flex: 2; background: #e8e8e8; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; padding: 32px; }
        /* è£œä¸Šå…¶é¤˜ä½ ä»£ç¢¼ä¸­çš„ CSS ... */
    </style>
</head>

<body>
    <header class="header">
        èŠ³å’Œå¯¦é©—ä¸­å­¸ç’°å¢ƒç¾æ³
        <div class="mqtt-notification" id="mqtt-notification"></div>
    </header>

    <div class="app-container">
        <div class="app">
            <aside class="sidebar">
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="source-selector">å°èŠ³å ‚ â–¼</button>
                    <ul class="dropdown-list hidden" id="source-list">
                        <li data-source="A">å°èŠ³å ‚</li>
                        <li data-source="B">å¸ä»¤å°</li>
                        <li data-source="E">æ¤ç‰©è§€æ¸¬</li>
                    </ul>
                </div>
                <div class="menu">
                    <div data-modal="pm25">PM2.5 æŒ‡æ•¸</div>
                </div>
                
                <div class="clock">
                    <svg id="clock-svg" viewBox="0 0 100 100">
                        <circle cx="50" cy="50" r="45" fill="none" stroke="#fff" stroke-width="4"/>
                        <rect id="hour-hand" x="48" y="25" width="4" height="25" rx="2" fill="#ddd" transform-origin="50px 50px"/>
                        <rect id="minute-hand" x="48.5" y="18" width="3" height="32" rx="1.5" fill="#fff" transform-origin="50px 50px"/>
                    </svg>
                    <div class="clock-digital">
                        <div id="date-display"></div>
                        <div id="time-display" style="font-weight: bold;"></div>
                    </div>
                </div>
            </aside>

            <main class="main" id="standard-layout">
                <section class="columns">
                    <div class="pm25">
                        <div class="pm25-label">PM2.5</div>
                        <div class="pm25-value" id="pm25-value">--</div>
                    </div>
                    <div class="ai-insight-box">
                        <strong>ğŸ¤– Gemini AI ç’°å¢ƒå»ºè­°ï¼š</strong>
                        <p id="ai-text">æ­£åœ¨åˆ†ææ ¡åœ’æ•¸æ“š...</p>
                    </div>
                </section>
            </main>

            <main class="main" id="plant-layout" style="display:none;">
                <div class="plant-top-pm25">
                    <div class="pm25-label">MQTT æ¤ç‰©ç›£æ¸¬ PM2.5</div>
                    <div class="pm25-value" id="plant-pm25-value">--</div>
                </div>
                <div class="ai-insight-box">
                    <strong>ğŸŒ¿ AI æ¤ç‰©ç”Ÿé•·å»ºè­°ï¼š</strong>
                    <p id="plant-ai-text">æ­£åœ¨è®€å–æ„Ÿæ¸¬å™¨æ•¸æ“š...</p>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { GoogleGenAI } from "@google/genai";

        // ğŸš¨ è«‹åœ¨æ­¤è™•å¡«å…¥ä½ çš„ API Keyï¼Œæˆ–è€…ç¢ºä¿ Vercel ç’°å¢ƒè®Šæ•¸æœ‰ GEMINI_API_KEY
        const API_KEY = "ä½ çš„_GEMINI_API_KEY"; 

        // æ•¸æ“šæ›´æ–°èˆ‡ AI åˆ†æ
        async function updateAI(val, elementId) {
            if (API_KEY === "ä½ çš„_GEMINI_API_KEY") {
                document.getElementById(elementId).innerText = "è«‹è¨­å®š API Key ä»¥å•Ÿç”¨ AI åˆ†æã€‚";
                return;
            }
            try {
                const genAI = new GoogleGenAI(API_KEY);
                const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" });
                const prompt = `èŠ³å’Œå¯¦é©—ä¸­å­¸ç›®å‰çš„ PM2.5 æŒ‡æ•¸æ˜¯ ${val}ï¼Œè«‹çµ¦å­¸ç”Ÿä¸€å¥ç°¡çŸ­çš„å¥åº·æé†’ã€‚`;
                const result = await model.generateContent(prompt);
                document.getElementById(elementId).innerText = result.response.text();
            } catch (e) { console.error(e); }
        }

        // ä½ åŸæœ¬çš„ MQTT èˆ‡ UI é‚è¼¯...
        // (è«‹ä¿ç•™ä½ åŸæœ¬ script æ¨™ç±¤ä¸­é—œæ–¼ fetchData, updateClock, connectMQTT çš„å…§å®¹)
        // åªè¦åœ¨ fetchData æˆåŠŸå¾Œå‘¼å« updateAI(data.s_d0, 'ai-text') å³å¯ã€‚
        
        // --- ç¯„ä¾‹æ•´åˆ ---
        window.fetchData = async function() {
            const res = await fetch('https://pm25.lass-net.org/data/last.php?device_id=B827EBC2994D');
            const data = await res.json();
            const val = data.s_d0 || 0;
            document.getElementById('pm25-value').innerText = val + " Î¼g/mÂ³";
            updateAI(val, 'ai-text');
        };
        fetchData();
        setInterval(fetchData, 60000);
    </script>
</body>
</html>
