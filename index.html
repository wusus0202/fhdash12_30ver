/* 這是 script 標籤內需要修正與補強的部分 */

// ... 前面的 getLevelColor, fetchLoop 等維持不變 ...

// 修正後的開啟趨勢視窗函數
async function openModal(title, field, btn) {
    document.querySelectorAll('.trend-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    document.getElementById('modal-title').innerText = `${config[currentKey].name || '測站'} - ${title} (24H趨勢)`;
    document.getElementById('modal-overlay').classList.add('active');
    
    // 更新圖例 (Legend)
    const leg = document.getElementById('modal-legend');
    leg.innerHTML = '';
    if(standards[field]) {
        standards[field].forEach(s => {
            leg.innerHTML += `<div class="std-box" style="background:${s.c}">${s.l}<br>${s.v}</div>`;
        });
    }

    // --- 新增：真正的數據抓取邏輯 ---
    try {
        const res = await fetch(`https://pm25.lass-net.org/data/history.php?device_id=${config[currentKey]}`);
        const json = await res.json();
        
        const deviceData = json.feeds[0];
        const deviceKey = Object.keys(deviceData)[0];
        const rawHistory = deviceData[deviceKey];

        const now = new Date().getTime();
        const cutoff = now - (24 * 60 * 60 * 1000); // 24小時
        const interval = 15 * 60 * 1000; // 15分鐘一個點
        
        let allPoints = [];
        rawHistory.forEach(f => {
            const tsKey = Object.keys(f)[0];
            const d = f[tsKey];
            if (d && d[field] !== undefined) {
                const ts = new Date(d.timestamp || tsKey).getTime();
                if (ts >= cutoff) allPoints.push({ x: ts, y: parseFloat(d[field]) });
            }
        });

        // 15分鐘降維計算平均值
        const grouped = new Map();
        allPoints.forEach(p => {
            const slot = Math.floor(p.x / interval) * interval;
            if (!grouped.has(slot)) grouped.set(slot, { sum: 0, count: 0 });
            const g = grouped.get(slot);
            g.sum += p.y;
            g.count += 1;
        });

        let finalPoints = [];
        grouped.forEach((v, k) => finalPoints.append({ x: k, y: v.sum / v.count }));
        finalPoints.sort((a, b) => a.x - b.x);

        // 更新圖表渲染
        chart.data.labels = finalPoints.map(p => {
            const t = new Date(p.x);
            return `${t.getHours()}:${String(t.getMinutes()).padStart(2, '0')}`;
        });
        chart.data.datasets[0].label = title;
        chart.data.datasets[0].data = finalPoints.map(p => p.y.toFixed(1));
        
        // 根據目前數值自動改顏色
        const currentVal = finalPoints[finalPoints.length-1]?.y || 0;
        const themeColor = getLevelColor(field === 's_d0' ? 'pm25' : (field === 's_t0' ? 'temp' : 'co2'), currentVal);
        chart.data.datasets[0].borderColor = themeColor;
        chart.data.datasets[0].backgroundColor = themeColor + '22';
        
        chart.update();

    } catch (e) {
        console.error("歷史數據讀取失敗", e);
    }
}

// 修正 initCharts 中的 chart 設定，讓它預設空白
function initCharts() {
    gauge = new Chart(document.getElementById('gaugeCanvas'), {
        type: 'doughnut',
        data: { datasets: [{ data: [0, 100], circumference: 270, rotation: 225, cutout: '85%', borderRadius: 10 }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
    });
    
    chart = new Chart(document.getElementById('chartCanvas'), {
        type: 'line',
        data: { labels: [], datasets: [{ label: '載入中...', data: [], borderColor: '#00cec9', tension: 0.4, fill: true }] },
        options: { 
            responsive: true, 
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: false } }
        }
    });
}
