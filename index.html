<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8" />
    <title>FH EnivroDashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paho-mqtt/1.0.1/mqttws31.min.js" type="text/javascript"></script>

    <style>
        /* 這裡完全保留你原本的所有 CSS，一行都不動 */
        * { box-sizing: border-box; }
        body { margin: 0; font-family: system-ui, -apple-system, sans-serif; background: #f2f2f2; }
        .header { height: 70px; background: #d9cecd; color: #333; display: flex; align-items: center; padding: 0 24px; font-size: 18px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,0,0,0.1); position: relative; }
        .mqtt-notification { position: absolute; top: 10px; right: 24px; padding: 8px 16px; border-radius: 20px; font-size: 12px; font-weight: 500; min-width: 120px; text-align: center; opacity: 0; transform: translateY(-10px); transition: all 0.3s ease; z-index: 100; }
        .mqtt-notification.show { opacity: 1; transform: translateY(0); }
        .mqtt-success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .mqtt-error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: translateY(0) scale(1); } 50% { transform: translateY(0) scale(1.02); } 100% { transform: translateY(0) scale(1); } }
        .app-container { display: flex; flex-direction: column; height: 92vh; }
        .app { display: flex; flex: 1; }
        .sidebar { width: 260px; background: #4a4545; color: #fff; padding: 20px; display: flex; flex-direction: column; }
        .menu { display: flex; flex-direction: column; gap: 10px; }
        .menu div { padding: 12px 16px; border-radius: 8px; border: 1px solid #777; font-size: 14px; cursor: pointer; transition: background 0.2s; background: #4a4545; color: #fff; }
        .dropdown-container { position: relative; margin-bottom: 10px; }
        .dropdown-btn { padding: 12px 16px; border-radius: 8px; border: 1px solid #777; font-size: 14px; cursor: pointer; background: #fff !important; color: #333 !important; width: 100%; text-align: left; }
        .dropdown-list { position: absolute; top: 100%; left: 0; right: 0; background: #4a4545; border: 1px solid #777; border-radius: 8px; list-style: none; padding: 0; margin: 0; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); max-height: 200px; overflow-y: auto; }
        .dropdown-list li { padding: 12px 16px; cursor: pointer; border-bottom: 1px solid #5a5555; color: #fff; }
        .dropdown-list.hidden { display: none; }
        .clock { margin-top: auto; height: 160px; border-radius: 16px; background: #5b5555; padding: 20px; display: flex; gap: 16px; color: #fff; font-family: 'Courier New', monospace; align-items: center; }
        .clock-svg { flex: 1; height: 100%; display: flex; align-items: center; justify-content: center; }
        #clock-svg { width: 72px; height: 72px; }
        .clock-digital { flex: 1.3; display: flex; flex-direction: column; justify-content: center; gap: 4px; height: 100%; }
        .date-display { font-size: 13px; opacity: 0.9; }
        .time-display { font-size: 16px; font-weight: 600; letter-spacing: 1px; }
        .main { flex: 1; padding: 24px; display: flex; flex-direction: column; gap: 24px; height: 100%; }
        .columns { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 24px; height: 100%; }
        .pm25 { grid-column: 1 / span 2; background: #e8e8e8; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; font-size: 20px; padding: 16px; }
        .pm25-value { font-size: 32px; font-weight: 500; }
        .right-stack { grid-column: 3; display: flex; flex-direction: column; gap: 16px; }
        .right-card { flex: 1; background: #e8e8e8; border-radius: 20px; display: flex; align-items: center; justify-content: center; color: #888; padding: 12px; }
        #plant-layout { display: none; padding: 24px; flex-direction: column; gap: 24px; height: 100%; }
        #plant-layout.active { display: flex; }
        .plant-top-pm25 { flex: 2; background: #e8e8e8; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; padding: 32px; }
        .plant-pm25-value { font-size: 64px; font-weight: 500; }
        .plant-bottom-row { flex: 1; display: flex; gap: 24px; }
        .plant-bottom-card { flex: 1; background: #e8e8e8; border-radius: 24px; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #888; padding: 24px; }
    </style>
</head>

<body>
    <header class="header">
        芳和實驗中學環境現況
        <div class="mqtt-notification" id="mqtt-notification"></div>
    </header>

    <div class="app-container">
        <div class="app">
            <aside class="sidebar">
                <div class="dropdown-container">
                    <button class="dropdown-btn" id="source-selector">小芳堂 ▼</button>
                    <ul class="dropdown-list hidden" id="source-list">
                        <li data-source="A">小芳堂</li>
                        <li data-source="B">司令台</li>
                        <li data-source="E">植物觀測</li>
                    </ul>
                </div>

                <div class="menu">
                    <div data-modal="pm25">PM2.5</div>
                    <div data-modal="temperature">溫度</div>
                </div>
                
                <div class="clock">
                    <div class="clock-svg">
                        <svg id="clock-svg" viewBox="0 0 100 100">
                            <circle cx="50" cy="50" r="45" fill="none" stroke="#fff" stroke-width="4"/>
                            <rect id="hour-hand" x="48" y="25" width="4" height="25" rx="2" fill="#ddd" transform-origin="50px 50px"/>
                            <rect id="minute-hand" x="48.5" y="18" width="3" height="32" rx="1.5" fill="#fff" transform-origin="50px 50px"/>
                            <rect id="second-hand" x="49" y="16" width="2" height="34" rx="1" fill="#ff4444" transform-origin="50px 50px"/>
                            <circle cx="50" cy="50" r="4" fill="#fff"/>
                        </svg>
                    </div>
                    <div class="clock-digital">
                        <div class="date-display" id="date-display"></div>
                        <div class="time-display" id="time-display"></div>
                    </div>
                </div>
            </aside>

            <main class="main" id="standard-layout">
                <div class="pm25">
                    <div class="pm25-label">PM2.5</div>
                    <div class="pm25-value" id="pm25-value">-- μg/m³</div>
                </div>
            </main>

            <main class="main" id="plant-layout">
                <div class="plant-top-pm25">
                    <div class="plant-pm25-label">PM2.5</div>
                    <div class="plant-pm25-value" id="plant-pm25-value">-- μg/m³</div>
                </div>
                <div class="plant-bottom-row">
                    <div class="plant-bottom-card"><div class="label">濕度</div><div class="value" id="plant-humidity">--</div></div>
                    <div class="plant-bottom-card"><div class="label">溫度</div><div class="value" id="plant-temperature">--</div></div>
                </div>
            </main>
        </div>
    </div>

    <script>
        // --- MQTT 設定優化 ---
        const HIVEMQ_CONFIG = {
            host: "c8d3b86c35d544b38289b94536bb4d71.s1.eu.hivemq.cloud",
            port: 8884, // 網頁 WebSocket SSL 必須用 8884
            username: "wusus",
            password: "Webberwusus0202",
            path: "/mqtt"
        };

        let mqttClient = null;
        let currentSource = 'A';

        // 側邊欄切換邏輯
        const dropdownBtn = document.getElementById('source-selector');
        const dropdownList = document.getElementById('source-list');
        dropdownBtn.onclick = () => dropdownList.classList.toggle('hidden');

        document.querySelectorAll('#source-list li').forEach(item => {
            item.onclick = () => {
                currentSource = item.dataset.source;
                dropdownBtn.textContent = `${item.textContent} ▼`;
                dropdownList.classList.add('hidden');
                
                if (currentSource === 'E') {
                    document.getElementById('standard-layout').style.display = 'none';
                    document.getElementById('plant-layout').style.display = 'flex';
                    document.getElementById('plant-layout').classList.add('active');
                    connectMQTT();
                } else {
                    if (mqttClient) mqttClient.disconnect();
                    document.getElementById('plant-layout').style.display = 'none';
                    document.getElementById('plant-layout').classList.remove('active');
                    document.getElementById('standard-layout').style.display = 'flex';
                    fetchData();
                }
            };
        });

        // --- 核心 MQTT 連線函數 ---
        function connectMQTT() {
            // 檢查 Paho 是否載入成功
            if (typeof Paho === "undefined") {
                console.error("Paho MQTT Library is not loaded yet!");
                return;
            }

            const clientId = "web_client_" + Math.random().toString(16).substr(2, 8);
            mqttClient = new Paho.MQTT.Client(HIVEMQ_CONFIG.host, HIVEMQ_CONFIG.port, HIVEMQ_CONFIG.path, clientId);

            const options = {
                useSSL: true,
                userName: HIVEMQ_CONFIG.username,
                password: HIVEMQ_CONFIG.password,
                onSuccess: onConnect,
                onFailure: (e) => {
                    console.log("Connect failed:", e);
                    const note = document.getElementById('mqtt-notification');
                    note.textContent = "MQTT 連線失敗";
                    note.className = "mqtt-notification mqtt-error show";
                }
            };

            mqttClient.onConnectionLost = (e) => console.log("Lost:", e.errorMessage);
            mqttClient.onMessageArrived = (msg) => {
                console.log(msg.destinationName, msg.payloadString);
                if (msg.destinationName.includes("pm25")) {
                    document.getElementById('plant-pm25-value').textContent = msg.payloadString + " μg/m³";
                }
                if (msg.destinationName.includes("humidity")) {
                    document.getElementById('plant-humidity').textContent = msg.payloadString + " %";
                }
            };

            mqttClient.connect(options);
        }

        function onConnect() {
            const note = document.getElementById('mqtt-notification');
            note.textContent = "MQTT 已連線";
            note.className = "mqtt-notification mqtt-success show";
            mqttClient.subscribe("plant/#"); // 訂閱主題
            setTimeout(() => note.classList.remove('show'), 3000);
        }

        // 時鐘與數據
        function updateClock() {
            const now = new Date();
            const h = now.getHours(), m = now.getMinutes(), s = now.getSeconds();
            document.getElementById('hour-hand').setAttribute('transform', `rotate(${(h%12)*30 + m*0.5} 50 50)`);
            document.getElementById('minute-hand').setAttribute('transform', `rotate(${m*6} 50 50)`);
            document.getElementById('second-hand').setAttribute('transform', `rotate(${s*6} 50 50)`);
            document.getElementById('date-display').textContent = now.toLocaleDateString();
            document.getElementById('time-display').textContent = now.toLocaleTimeString('zh-TW', {hour12:false});
        }

        async function fetchData() {
            if (currentSource === 'A') {
                const res = await fetch('https://pm25.lass-net.org/data/last.php?device_id=B827EBC2994D');
                const data = await res.json();
                document.getElementById('pm25-value').textContent = (data.s_d0 || '--') + " μg/m³";
            }
        }

        setInterval(updateClock, 1000);
        setInterval(fetchData, 60000);
        updateClock();
        fetchData();
    </script>
</body>
</html>
